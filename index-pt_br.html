<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protótipo dApp CSA</title>
    <!-- Imports the ethers.js library -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2em auto; padding: 1em; border: 1px solid #ccc; border-radius: 8px; }
        button { font-size: 1em; padding: 0.5em 1em; cursor: pointer; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; }
        button:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        input { font-size: 1em; padding: 0.5em; width: 80px; }
        input:read-only { background-color: #f0f0f0; }
        #status { margin-top: 1em; padding: 0.5em; background-color: #f0f0f0; border-radius: 4px; word-break: break-all; }
        .section { margin-top: 1.5em; padding-top: 1em; border-top: 1px solid #eee; }
        .season-card { border: 1px solid #ddd; padding: 1em; margin-bottom: 1em; border-radius: 5px; }
        .season-card small { display:block; margin-top:5px; color: #555; }
    </style>
</head>
<body>
    <h1>Protótipo de dApp para CSA (Comunidade que Sustenta a Agricultura)</h1>
    <p>Interaja com o contrato inteligente CSA / RWA (Ativos do Mundo Real) diretamente daqui!</p>
    
    <button id="connectButton">Conectar Carteira</button>
    <hr>
    
    <!-- This section will be dynamically populated with all available seasons -->
    <div id="seasonsForSaleSection" class="section" style="display:none;">
        <h3>Temporadas Abertas para Compra</h3>
        <div id="seasonsList">
            <!-- Available seasons will be injected here by JavaScript -->
        </div>
    </div>

    <div id="redeemSection" class="section" style="display:none;">
        <h3>Resgatar Box Semanal</h3>
        <p>Bem-vindo de volta! Encontramos sua cota.</p>
        <label for="tokenId">Seu Token ID:</label>
        <input type="number" id="tokenId" placeholder="0" readonly> 
        <button id="redeemButton">Resgatar Box</button>
    </div>

    <div id="status">Conecte sua carteira para começar...</div>

    <script>
        // --- DOM Element References ---
        const connectButton = document.getElementById('connectButton');
        const statusDiv = document.getElementById('status');
        
        const seasonsForSaleSection = document.getElementById('seasonsForSaleSection');
        const seasonsList = document.getElementById('seasonsList');
        const redeemSection = document.getElementById('redeemSection');
        const redeemButton = document.getElementById('redeemButton');
        const tokenIdInput = document.getElementById('tokenId');

        // --- Contract Configuration ---
        const contractAddress = "0x1c96D0701B1bd9c3CC24fAcca3A4d68ED8Bfb1AF"; 
        
        const contractABI = [
            // Functions
            "function buyMembership() payable",
            "function redeemWeeklyBox(uint256 tokenId)",
            "function seasons(uint256) view returns (string name, uint256 membershipPrice, uint256 totalMemberships, uint256 soldMemberships, uint256 startTime, uint256 endTime, bool isOpenForSale)",
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            // Events - This is crucial for querying historical data
            "event SeasonCreated(uint256 seasonId, string name, uint256 price, uint256 capacity)"
        ];

        // --- Global State Variables ---
        let provider, signer, contract;

        /**
         * @notice Fetches season data by querying past 'SeasonCreated' events
         * to determine the total number of seasons, then displays them.
         */
        async function loadSeasons() {
            try {
                seasonsList.innerHTML = 'Buscando histórico de temporadas na blockchain...';
                
                // Query the blockchain for all past logs of the 'SeasonCreated' event.
                const logs = await contract.queryFilter('SeasonCreated', 0, 'latest');
                const seasonsCount = logs.length;
                console.log(`Found ${seasonsCount} 'SeasonCreated' events.`);

                if (seasonsCount === 0) {
                    seasonsList.innerHTML = '<p>Nenhuma temporada foi criada ainda.</p>';
                    return;
                }

                seasonsList.innerHTML = ''; // Clear loading message

                // Loop through each season based on the number of events found.
                for (let i = 0; i < seasonsCount; i++) {
                    const season = await contract.seasons(i);
                    
                    // Only display seasons that are marked as open for sale.
                    if (season.isOpenForSale) {
                        const priceInAvax = ethers.utils.formatEther(season.membershipPrice);
                        // The original contract only allows buying the LATEST season.
                        const isLastSeason = (i === seasonsCount - 1);

                        const seasonCard = document.createElement('div');
                        seasonCard.className = 'season-card';
                        
                        // Dynamically create the HTML for the season card.
                        // Disable the buy button if it's not the last season.
                        seasonCard.innerHTML = `
                            <h4>${season.name} (ID: ${i})</h4>
                            <p><strong>Preço:</strong> ${priceInAvax} AVAX</p>
                            <p><strong>Cotas vendidas:</strong> ${season.soldMemberships.toString()} / ${season.totalMemberships.toString()}</p>
                            <button class="buy-button" data-price-wei="${season.membershipPrice.toString()}" ${!isLastSeason ? 'disabled' : ''}>Comprar Cota</button>
                            ${!isLastSeason ? '<small>A compra só é permitida para a temporada mais recente.</small>' : ''}
                        `;
                        seasonsList.appendChild(seasonCard);
                    }
                }
                
                // Attach the click event handler ONLY to the enabled buy buttons.
                document.querySelectorAll('.buy-button:not([disabled])').forEach(button => {
                    button.addEventListener('click', handleBuyClick);
                });

            } catch (error) {
                seasonsList.innerHTML = '<p>Erro ao carregar as temporadas.</p>';
                console.error("Error fetching seasons data:", error);
            }
        }
        
        /**
         * @notice Handles the click event for a "Buy" button.
         * Calls the contract's buyMembership function.
         */
        async function handleBuyClick(event) {
            const button = event.target;
            const priceWei = button.dataset.priceWei;

            try {
                button.disabled = true;
                button.textContent = 'Aguardando...';
                statusDiv.textContent = `Iniciando compra para a temporada mais recente...`;

                // The contract function takes no arguments, it automatically sells the last season.
                const tx = await contract.buyMembership({ value: priceWei });
                statusDiv.textContent = `Transação de compra enviada! Aguardando...`;
                
                await tx.wait();
                statusDiv.textContent = "Sucesso! Cota comprada! Atualize a página para ver a seção de resgate.";
                button.style.display = 'none';

            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Erro na compra: ${error.reason || error.message}`;
                button.disabled = false;
                button.textContent = 'Comprar Cota';
            }
        }

        // --- Main Event Listeners ---

        /**
         * @notice Connects to the user's wallet (e.g., MetaMask) and sets up the dApp state.
         */
        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    const userAddress = await signer.getAddress();
                    statusDiv.textContent = `Conectado: ${userAddress.substring(0, 6)}...`;
                    connectButton.style.display = 'none';
                    
                    // Check if the user already owns a membership NFT.
                    const balance = await contract.balanceOf(userAddress);
                    if (balance.toNumber() > 0) {
                        // If user is a member, show the redeem section.
                        redeemSection.style.display = 'block';
                        const userTokenId = await contract.tokenOfOwnerByIndex(userAddress, 0);
                        tokenIdInput.value = userTokenId.toNumber();
                    } else {
                        // If user is not a member, show the purchase section and load seasons.
                        seasonsForSaleSection.style.display = 'block';
                        await loadSeasons();
                    }

                } catch (error) {
                    statusDiv.textContent = `Erro ao conectar: ${error.message}`;
                }
            } else {
                statusDiv.textContent = "MetaMask não encontrada!";
            }
        });

        /**
         * @notice Handles the weekly box redemption.
         */
        redeemButton.addEventListener('click', async () => {
            const tokenId = tokenIdInput.value;
            if (tokenId === "" || parseInt(tokenId) < 0) {
                statusDiv.textContent = "Por favor, insira um Token ID válido.";
                return;
            }
            try {
                redeemButton.disabled = true;
                statusDiv.textContent = `Enviando transação para resgatar o box do token #${tokenId}...`;
                const tx = await contract.redeemWeeklyBox(tokenId);
                statusDiv.textContent = `Transação enviada! Aguardando...`;
                await tx.wait();
                statusDiv.textContent = `Sucesso! Box para o Token ID #${tokenId} resgatado!`;
            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Erro ao resgatar: ${error.reason || error.message}`;
            } finally {
                redeemButton.disabled = false;
            }
        });
    </script>
</body>
</html>