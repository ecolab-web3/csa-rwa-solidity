<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protótipo dApp CSA</title>
    <!-- Imports the ethers.js library -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2em auto; padding: 1em; border: 1px solid #ccc; border-radius: 8px; }
        button { font-size: 1em; padding: 0.5em 1em; cursor: pointer; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; }
        button:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        input { font-size: 1em; padding: 0.5em; width: 80px; }
        input:read-only { background-color: #f0f0f0; }
        #status { margin-top: 1em; padding: 0.5em; background-color: #f0f0f0; border-radius: 4px; word-break: break-all; }
        .section { margin-top: 1.5em; padding-top: 1em; border-top: 1px solid #eee; }
        .season-card { border: 1px solid #ddd; padding: 1em; margin-bottom: 1em; border-radius: 5px; }
        .season-card small { display:block; margin-top:5px; color: #555; }
    </style>
</head>
<body>
    <h1>Protótipo de dApp para CSA (Comunidade que Sustenta a Agricultura)</h1>
    <p>Interaja com o contrato inteligente CSA / RWA (Ativos do Mundo Real) diretamente daqui!</p>
    
    <button id="connectButton">Conectar Carteira</button>
    <hr>
    
    <!-- This section will be dynamically populated with all available seasons -->
    <div id="seasonsForSaleSection" class="section" style="display:none;">
        <h3>Temporadas Abertas para Compra</h3>
        <div id="seasonsList">
            <!-- Available seasons will be injected here by JavaScript -->
        </div>
    </div>

    <div id="redeemSection" class="section" style="display:none;">
        <h3>Resgatar Box Semanal</h3>
        <p>Bem-vindo de volta! Encontramos sua cota.</p>
        <label for="tokenId">Seu Token ID:</label>
        <input type="number" id="tokenId" placeholder="0" readonly> 
        <button id="redeemButton">Resgatar Box</button>
    </div>

    <div id="status">Conecte sua carteira para começar...</div>

    <script>
        // --- DOM Element References ---
        const connectButton = document.getElementById('connectButton');
        const statusDiv = document.getElementById('status');
        
        const seasonsForSaleSection = document.getElementById('seasonsForSaleSection');
        const seasonsList = document.getElementById('seasonsList');
        const redeemSection = document.getElementById('redeemSection');
        const redeemButton = document.getElementById('redeemButton');
        const tokenIdInput = document.getElementById('tokenId');

        // --- Contract Configuration ---
        const contractAddress = "0x1c96D0701B1bd9c3CC24fAcca3A4d68ED8Bfb1AF";
        const TARGET_NETWORK_ID = 43113; // Fuji Testnet Chain ID
        
        const contractABI = [
            "function buyMembership() payable",
            "function redeemWeeklyBox(uint256 tokenId)",
            "function seasons(uint256) view returns (string name, uint256 membershipPrice, uint256 totalMemberships, uint256 soldMemberships, uint256 startTime, uint256 endTime, bool isOpenForSale)",
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "event SeasonCreated(uint256 seasonId, string name, uint256 price, uint256 capacity)"
        ];

        // --- Global State Variables ---
        let provider, signer, contract;

        /**
         * @notice Fetches season data by querying past 'SeasonCreated' events
         * to determine the total number of seasons, then displays them.
         */
        async function loadSeasons() {
            try {
                seasonsList.innerHTML = 'Buscando histórico de temporadas na blockchain...';
                
                const logs = await contract.queryFilter('SeasonCreated', 0, 'latest');
                const seasonsCount = logs.length;
                console.log(`Found ${seasonsCount} 'SeasonCreated' events.`);

                if (seasonsCount === 0) {
                    seasonsList.innerHTML = '<p>Nenhuma temporada foi criada ainda.</p>';
                    return;
                }

                seasonsList.innerHTML = ''; 

                for (let i = 0; i < seasonsCount; i++) {
                    const season = await contract.seasons(i);
                    
                    if (season.isOpenForSale) {
                        const priceInAvax = ethers.utils.formatEther(season.membershipPrice);
                        const isLastSeason = (i === seasonsCount - 1);

                        const seasonCard = document.createElement('div');
                        seasonCard.className = 'season-card';
                        
                        seasonCard.innerHTML = `
                            <h4>${season.name} (ID: ${i})</h4>
                            <p><strong>Preço:</strong> ${priceInAvax} AVAX</p>
                            <p><strong>Cotas vendidas:</strong> ${season.soldMemberships.toString()} / ${season.totalMemberships.toString()}</p>
                            <button class="buy-button" data-price-wei="${season.membershipPrice.toString()}" ${!isLastSeason ? 'disabled' : ''}>Comprar Cota</button>
                            ${!isLastSeason ? '<small>A compra só é permitida para a temporada mais recente.</small>' : ''}
                        `;
                        seasonsList.appendChild(seasonCard);
                    }
                }
                
                document.querySelectorAll('.buy-button:not([disabled])').forEach(button => {
                    button.addEventListener('click', handleBuyClick);
                });

            } catch (error) {
                // --- IMPROVED: More descriptive error message ---
                seasonsList.innerHTML = `<p>Erro ao carregar as temporadas. Isso pode ocorrer por uma instabilidade temporária na rede de testes. Por favor, tente recarregar a página em alguns instantes.</p>`;
                console.error("Error fetching seasons data:", error);
            }
        }
        
        /**
         * @notice Handles the click event for a "Buy" button.
         */
        async function handleBuyClick(event) {
            const button = event.target;
            const priceWei = button.dataset.priceWei;

            try {
                button.disabled = true;
                button.textContent = 'Aguardando...';
                statusDiv.textContent = `Iniciando compra para a temporada mais recente...`;

                const tx = await contract.buyMembership({ value: priceWei });
                statusDiv.textContent = `Transação de compra enviada! Aguardando...`;
                
                await tx.wait();
                statusDiv.textContent = "Sucesso! Cota comprada! Atualize a página para ver a seção de resgate.";
                button.style.display = 'none';

            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Erro na compra: ${error.reason || error.message}`;
                button.disabled = false;
                button.textContent = 'Comprar Cota';
            }
        }

        // --- Main Event Listeners ---

        /**
         * @notice Connects to the user's wallet, checks the network, and sets up the dApp state.
         */
        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);

                    // --- Network check ---
                    const { chainId } = await provider.getNetwork();
                    if (chainId !== TARGET_NETWORK_ID) {
                        statusDiv.textContent = `Rede errada! Por favor, conecte sua carteira à Avalanche Fuji Testnet (Chain ID ${TARGET_NETWORK_ID}).`;
                        return; // Stop the execution if the network is wrong.
                    }

                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    const userAddress = await signer.getAddress();
                    statusDiv.textContent = `Conectado: ${userAddress.substring(0, 6)}...`;
                    connectButton.style.display = 'none';
                    
                    const balance = await contract.balanceOf(userAddress);
                    if (balance.toNumber() > 0) {
                        redeemSection.style.display = 'block';
                        const userTokenId = await contract.tokenOfOwnerByIndex(userAddress, 0);
                        tokenIdInput.value = userTokenId.toNumber();
                    } else {
                        seasonsForSaleSection.style.display = 'block';
                        await loadSeasons();
                    }

                } catch (error) {
                    statusDiv.textContent = `Erro ao conectar: ${error.message}`;
                }
            } else {
                statusDiv.textContent = "MetaMask não encontrada!";
            }
        });

        /**
         * @notice Handles the weekly box redemption.
         */
        redeemButton.addEventListener('click', async () => {
            // This function's logic remains the same.
            const tokenId = tokenIdInput.value;
            if (tokenId === "" || parseInt(tokenId) < 0) {
                statusDiv.textContent = "Por favor, insira um Token ID válido.";
                return;
            }
            try {
                redeemButton.disabled = true;
                statusDiv.textContent = `Enviando transação para resgatar o box do token #${tokenId}...`;
                const tx = await contract.redeemWeeklyBox(tokenId);
                statusDiv.textContent = `Transação enviada! Aguardando...`;
                await tx.wait();
                statusDiv.textContent = `Sucesso! Box para o Token ID #${tokenId} resgatado!`;
            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Erro ao resgatar: ${error.reason || error.message}`;
            } finally {
                redeemButton.disabled = false;
            }
        });
    </script>
</body>
</html>