<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protótipo dApp CSA</title>
    <!-- Imports the ethers.js library -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2em auto; padding: 1em; border: 1px solid #ccc; border-radius: 8px; }
        button { font-size: 1em; padding: 0.5em 1em; cursor: pointer; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; }
        button:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        input { font-size: 1em; padding: 0.5em; width: 80px; }
        input:read-only { background-color: #f0f0f0; }
        #status { margin-top: 1em; padding: 0.5em; background-color: #f0f0f0; border-radius: 4px; word-break: break-all; }
        .section { margin-top: 1.5em; padding-top: 1em; border-top: 1px solid #eee; }
        .season-card { border: 1px solid #ddd; padding: 1em; margin-bottom: 1em; border-radius: 5px; }
        .season-card small { display:block; margin-top:5px; color: #555; }
        
        /* --- Debug Panel Styles --- */
        #debugPanel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: #222;
            color: #0f0;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            opacity: 0.9;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>Protótipo de dApp para CSA (Comunidade que Sustenta a Agricultura)</h1>
    <p>Interaja com o contrato inteligente CSA / RWA (Ativos do Mundo Real) diretamente daqui!</p>
    
    <button id="connectButton">Conectar Carteira</button>
    <hr>
    
    <div id="seasonsForSaleSection" class="section" style="display:none;">
        <h3>Temporadas Abertas para Compra</h3>
        <div id="seasonsList"></div>
    </div>

    <div id="redeemSection" class="section" style="display:none;">
        <h3>Resgatar Box Semanal</h3>
        <p>Bem-vindo de volta! Encontramos sua cota.</p>
        <label for="tokenId">Seu Token ID:</label>
        <input type="number" id="tokenId" placeholder="0" readonly> 
        <button id="redeemButton">Resgatar Box</button>
    </div>

    <div id="status">Conecte sua carteira para começar...</div>

    <!-- --- Debug Panel --- -->
    <div id="debugPanel">
        <strong>Debug Info</strong><br>
        Status: Disconnected
    </div>

    <script>
        // --- DOM Element References ---
        const connectButton = document.getElementById('connectButton');
        const statusDiv = document.getElementById('status');
        const seasonsForSaleSection = document.getElementById('seasonsForSaleSection');
        const seasonsList = document.getElementById('seasonsList');
        const redeemSection = document.getElementById('redeemSection');
        const redeemButton = document.getElementById('redeemButton');
        const tokenIdInput = document.getElementById('tokenId');
        const debugPanel = document.getElementById('debugPanel');

        // --- Contract Configuration ---
        const contractAddress = "0x1c96D0701B1bd9c3CC24fAcca3A4d68ED8Bfb1AF";
        const TARGET_NETWORK_ID = 43113; // Fuji Testnet Chain ID
        
        const contractABI = [
            "function buyMembership() payable",
            "function redeemWeeklyBox(uint256 tokenId)",
            "function seasons(uint256) view returns (string name, uint256 membershipPrice, uint256 totalMemberships, uint256 soldMemberships, uint256 startTime, uint256 endTime, bool isOpenForSale)",
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)"
        ];

        // --- Global State Variables ---
        let provider, signer, contract;

        /**
         * @notice Updates the debug panel with real-time connection info.
         */
        async function updateDebugPanel(userAddress, network, latestBlock) {
            debugPanel.innerHTML = `
                <strong>Debug Info</strong><br>
                Status: Connected<br>
                Address: ${userAddress.substring(0,6)}...<br>
                Network: ${network.name} (${network.chainId})<br>
                Latest Block: <span id="blockNumber">${latestBlock}</span>
            `;
        }

        /**
         * @notice NEW ROBUST METHOD: Fetches seasons by iteratively calling the contract's
         * `seasons(id)` function until it reverts, which indicates the end of the array.
         */
        async function loadSeasons() {
            try {
                seasonsList.innerHTML = 'Buscando temporadas uma a uma (método robusto)...';
                const foundSeasons = [];
                let seasonId = 0;
                
                while (true) {
                    try {
                        const season = await contract.seasons(seasonId);
                        foundSeasons.push(season);
                        seasonId++;
                    } catch (error) {
                        // This error is EXPECTED. It means we've reached an invalid index.
                        // We can now break the loop.
                        console.log(`Search finished. Found ${seasonId} seasons.`);
                        break;
                    }
                }

                const seasonsCount = foundSeasons.length;
                if (seasonsCount === 0) {
                    seasonsList.innerHTML = '<p>Nenhuma temporada foi criada ainda.</p>';
                    return;
                }

                seasonsList.innerHTML = ''; 

                foundSeasons.forEach((season, index) => {
                    if (season.isOpenForSale) {
                        const priceInAvax = ethers.utils.formatEther(season.membershipPrice);
                        const isLastSeason = (index === seasonsCount - 1);
                        const seasonCard = document.createElement('div');
                        seasonCard.className = 'season-card';
                        seasonCard.innerHTML = `
                            <h4>${season.name} (ID: ${index})</h4>
                            <p><strong>Preço:</strong> ${priceInAvax} AVAX</p>
                            <p><strong>Cotas vendidas:</strong> ${season.soldMemberships.toString()} / ${season.totalMemberships.toString()}</p>
                            <button class="buy-button" data-price-wei="${season.membershipPrice.toString()}" ${!isLastSeason ? 'disabled' : ''}>Comprar Cota</button>
                            ${!isLastSeason ? '<small>A compra só é permitida para a temporada mais recente.</small>' : ''}
                        `;
                        seasonsList.appendChild(seasonCard);
                    }
                });
                
                document.querySelectorAll('.buy-button:not([disabled])').forEach(button => button.addEventListener('click', handleBuyClick));

            } catch (error) {
                seasonsList.innerHTML = `<p>Ocorreu um erro inesperado ao se comunicar com a blockchain.</p>`;
                console.error("Unexpected error in loadSeasons:", error);
            }
        }

        // --- Connection Handling (Mainly Unchanged) ---
        
        async function handleConnection() {
            try {
                if (!window.ethereum) {
                    statusDiv.textContent = "MetaMask não encontrada!";
                    return;
                }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                
                const { chainId, name } = await provider.getNetwork();
                if (chainId !== TARGET_NETWORK_ID) {
                    statusDiv.textContent = `Rede errada! Por favor, conecte sua carteira à Avalanche Fuji Testnet (Chain ID ${TARGET_NETWORK_ID}).`;
                    debugPanel.innerHTML = `<strong>Debug Info</strong><br>Status: Wrong Network<br>Connected to: ${name} (${chainId})`;
                    return;
                }

                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                const userAddress = await signer.getAddress();
                
                updateDebugPanel(userAddress, {name, chainId}, await provider.getBlockNumber());
                provider.on('block', (blockNumber) => {
                    const blockSpan = document.getElementById('blockNumber');
                    if(blockSpan) blockSpan.textContent = blockNumber;
                });

                statusDiv.textContent = `Conectado: ${userAddress.substring(0, 6)}...`;
                connectButton.style.display = 'none';
                
                const balance = await contract.balanceOf(userAddress);
                if (balance.toNumber() > 0) {
                    redeemSection.style.display = 'block';
                    const userTokenId = await contract.tokenOfOwnerByIndex(userAddress, 0);
                    tokenIdInput.value = userTokenId.toNumber();
                } else {
                    seasonsForSaleSection.style.display = 'block';
                    await loadSeasons();
                }

            } catch (error) {
                statusDiv.textContent = `Erro ao conectar: ${error.message}`;
                debugPanel.innerHTML = `<strong>Debug Info</strong><br>Status: Error<br>Message: ${error.message}`;
            }
        }
        
        async function tryAutoConnect() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) await handleConnection();
                } catch (error) {
                    console.error("Auto-connect failed:", error);
                }
            }
        }

        window.addEventListener('DOMContentLoaded', tryAutoConnect);
        connectButton.addEventListener('click', handleConnection);

        // --- Other Functions (handleBuyClick, redeem) remain the same ---
        async function handleBuyClick(event) {
            const button = event.target;
            const priceWei = button.dataset.priceWei;
            try {
                button.disabled = true;
                button.textContent = 'Aguardando...';
                statusDiv.textContent = `Iniciando compra para a temporada mais recente...`;
                const tx = await contract.buyMembership({ value: priceWei });
                statusDiv.textContent = `Transação de compra enviada! Aguardando...`;
                await tx.wait();
                statusDiv.textContent = "Sucesso! Cota comprada! Atualize a página para ver a seção de resgate.";
                button.style.display = 'none';
            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Erro na compra: ${error.reason || error.message}`;
                button.disabled = false;
                button.textContent = 'Comprar Cota';
            }
        }
        redeemButton.addEventListener('click', async () => {
            const tokenId = tokenIdInput.value;
            if (tokenId === "" || parseInt(tokenId) < 0) {
                statusDiv.textContent = "Por favor, insira um Token ID válido.";
                return;
            }
            try {
                redeemButton.disabled = true;
                statusDiv.textContent = `Enviando transação para resgatar o box do token #${tokenId}...`;
                const tx = await contract.redeemWeeklyBox(tokenId);
                statusDiv.textContent = `Transação enviada! Aguardando...`;
                await tx.wait();
                statusDiv.textContent = `Sucesso! Box para o Token ID #${tokenId} resgatado!`;
            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Erro ao resgatar: ${error.reason || error.message}`;
            } finally {
                redeemButton.disabled = false;
            }
        });
    </script>
</body>
</html>